---
import Layout from '../../layouts/Layout.astro'; 
import { getLangFromUrl, useTranslations } from '../../i18n/utils';

export function getStaticPaths() {
  return [
    { params: { lang: 'en' } },
    { params: { lang: 'cs' } },
  ];
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<Layout title="Client Portal | Roman Wantulok">
    
    <main class="relative min-h-screen w-full bg-black flex px-4 pt-28 md:pt-30 pb-20 items-center justify-center overflow-x-hidden p-4">
        
        <div class="fixed inset-0 z-0 overflow-hidden pointer-events-none">
            <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-black/50 to-black/90 z-10"></div>
            <img 
                src="/assets/images/americka-sila/detail-interior.webp" 
                class="w-full h-full object-cover opacity-60 blur-sm scale-105 animate-slow-zoom" 
                alt="Background" 
            />
        </div>

        <div id="auth-container" class="relative z-20 w-full max-w-md opacity-0 animate-fade-in-up" style="animation-delay: 0.2s;">
            
            <div class="bg-black/60 backdrop-blur-2xl border border-white/10 p-8 md:p-12 shadow-[0_20px_50px_rgba(0,0,0,0.5)] relative overflow-hidden rounded-2xl">
                <div class="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-gold/50 to-transparent"></div>
                <div class="text-center mb-10">
                    <p class="text-gold text-[10px] uppercase tracking-[0.4em] mb-3 font-medium">{t('client.system')}</p>
                    <h1 id="auth-title" class="text-3xl md:text-4xl font-serif text-white italic transition-all duration-500">{t('client.login_title')}</h1>
                </div>
                <div id="error-message" class="hidden bg-red-500/10 border border-red-500/20 text-red-200 text-xs p-4 rounded mb-6 text-center backdrop-blur-sm"></div>

                <form id="loginForm" class="space-y-6 block transition-all duration-300">
                    <div class="space-y-5">
                        <div class="group relative">
                            <input type="email" id="loginEmail" required class="peer w-full bg-white/5 border border-white/10 rounded px-4 pt-6 pb-2 text-white placeholder-transparent focus:outline-none focus:border-gold/50 focus:bg-white/10 transition-all duration-300 font-sans text-sm tracking-wide" placeholder="Email" />
                            <label for="loginEmail" class="absolute left-4 top-2 text-[10px] text-white/40 uppercase tracking-widest transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-white/30 peer-focus:top-2 peer-focus:text-[10px] peer-focus:text-gold pointer-events-none">{t('client.email_placeholder')}</label>
                        </div>
                        <div class="group relative">
                            <input type="password" id="loginPassword" required class="peer w-full bg-white/5 border border-white/10 rounded px-4 pt-6 pb-2 text-white placeholder-transparent focus:outline-none focus:border-gold/50 focus:bg-white/10 transition-all duration-300 font-sans text-sm tracking-wide" placeholder="Password" />
                            <label for="loginPassword" class="absolute left-4 top-2 text-[10px] text-white/40 uppercase tracking-widest transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-white/30 peer-focus:top-2 peer-focus:text-[10px] peer-focus:text-gold pointer-events-none">{t('client.pass_placeholder')}</label>
                        </div>
                    </div>
                    <button type="submit" class="group relative w-full bg-gold text-black font-bold py-4 text-xs uppercase tracking-[0.2em] hover:bg-white transition-all duration-300 mt-2 overflow-hidden cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="relative z-10 flex items-center justify-center">
                            <span class="btn-text">{t('client.login_btn')}</span>
                            <svg class="loading-spinner hidden animate-spin ml-2 h-4 w-4 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </span>
                    </button>
                    <div class="text-center pt-2">
                        <p class="text-white/30 text-xs">{t('client.no_account')} <button type="button" id="show-register-btn" class="text-white hover:text-gold transition-colors font-bold uppercase ml-1 tracking-widest cursor-pointer relative z-50">{t('client.signup')}</button></p>
                    </div>
                </form>

                <form id="registerForm" class="space-y-6 hidden transition-all duration-300">
                    <div class="space-y-5">
                        <div class="group relative">
                            <input type="text" id="regName" required class="peer w-full bg-white/5 border border-white/10 rounded px-4 pt-6 pb-2 text-white placeholder-transparent focus:outline-none focus:border-gold/50 focus:bg-white/10 transition-all duration-300 font-sans text-sm tracking-wide" placeholder="Name" />
                            <label for="regName" class="absolute left-4 top-2 text-[10px] text-white/40 uppercase tracking-widest transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-white/30 peer-focus:top-2 peer-focus:text-[10px] peer-focus:text-gold pointer-events-none">Full Name</label>
                        </div>
                        <div class="group relative">
                            <input type="email" id="regEmail" required class="peer w-full bg-white/5 border border-white/10 rounded px-4 pt-6 pb-2 text-white placeholder-transparent focus:outline-none focus:border-gold/50 focus:bg-white/10 transition-all duration-300 font-sans text-sm tracking-wide" placeholder="Email" />
                            <label for="regEmail" class="absolute left-4 top-2 text-[10px] text-white/40 uppercase tracking-widest transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-white/30 peer-focus:top-2 peer-focus:text-[10px] peer-focus:text-gold pointer-events-none">Email Address</label>
                        </div>
                        <div class="group relative">
                            <input type="password" id="regPassword" required class="peer w-full bg-white/5 border border-white/10 rounded px-4 pt-6 pb-2 text-white placeholder-transparent focus:outline-none focus:border-gold/50 focus:bg-white/10 transition-all duration-300 font-sans text-sm tracking-wide" placeholder="Pass" />
                            <label for="regPassword" class="absolute left-4 top-2 text-[10px] text-white/40 uppercase tracking-widest transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-white/30 peer-focus:top-2 peer-focus:text-[10px] peer-focus:text-gold pointer-events-none">Create Password</label>
                        </div>
                    </div>
                    <button type="submit" class="group relative w-full bg-white text-black font-bold py-4 text-xs uppercase tracking-[0.2em] hover:bg-gold transition-all duration-300 mt-2 overflow-hidden cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="relative z-10 flex items-center justify-center gap-2">
                            <span class="btn-text">{t('client.signup')}</span>
                            <svg class="loading-spinner hidden animate-spin ml-2 h-4 w-4 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </span>
                    </button>
                    <div class="text-center pt-2">
                        <p class="text-white/30 text-xs">Already have an account? <button type="button" id="show-login-btn" class="text-white hover:text-gold transition-colors font-bold uppercase ml-1 tracking-widest cursor-pointer relative z-50">{t('client.login_btn')}</button></p>
                    </div>
                </form>

                <div id="verify-message" class="hidden text-center animate-fade-in-up">
                    <div class="w-16 h-16 bg-gold/10 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#C5A059" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" /></svg>
                    </div>
                    <h2 class="text-2xl font-serif text-white mb-4">{t('client.verify_title')}</h2>
                    <p class="text-white/60 text-sm mb-8 leading-relaxed">{t('client.verify_desc')}</p>
                    <button id="back-to-login-btn" class="text-gold text-xs uppercase tracking-widest hover:text-white transition-colors border-b border-gold/30 pb-1 cursor-pointer">{t('client.back_login')}</button>
                </div>
            </div>
        </div>

        <div id="dashboard-section" class="hidden relative z-20 w-full max-w-6xl animate-fade-in-up">
            <div id="main-dashboard-view" class="transition-opacity duration-500">
                
                <div class="flex flex-col md:flex-row justify-between items-end mb-12 border-b border-white/10 pb-6 gap-4">
                    <div>
                        <p id="greeting-text" class="text-gold text-[10px] uppercase tracking-[0.4em] mb-2" data-morning={t('client.greeting_morning')} data-afternoon={t('client.greeting_afternoon')} data-evening={t('client.greeting_evening')}>{t('client.welcome')}</p>
                        <h1 class="text-3xl md:text-4xl font-serif text-white italic"><span id="user-name-display">Client</span></h1>
                        <p class="text-platinum/50 text-xs mt-2 font-mono">ID: <span id="user-email-display">...</span></p>
                    </div>
                    <div class="flex gap-4">
                        <button id="open-feedback-btn" class="text-[10px] text-gold border border-gold/30 px-4 py-2 hover:bg-gold hover:text-black transition-colors uppercase tracking-widest cursor-pointer">{t('client.rate')}</button>
                        <button id="logout-btn" class="text-[10px] text-red-500/60 hover:text-red-500 uppercase tracking-widest border border-red-900/20 px-6 py-3 rounded hover:bg-red-900/10 transition-colors cursor-pointer">{t('client.logout')}</button>
                    </div>
                </div>

                <div id="project-status-card" class="hidden bg-white/[0.02] border border-white/10 p-8 rounded-xl mb-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-gold"></div> 
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-white font-serif text-lg">{t('client.project_status')} <span id="project-name-display" class="text-gold italic"></span></h3>
                    </div>
                    
                    <div class="relative flex justify-between items-center px-2 md:px-8 py-4">
                        <div class="absolute left-0 top-1/2 -translate-y-1/2 w-full h-[1px] bg-white/10 z-0"></div>
                        <div id="status-progress-bar" class="absolute left-0 top-1/2 -translate-y-1/2 h-[1px] bg-gold z-0 shadow-[0_0_10px_#C5A059] transition-all duration-1000" style="width: 0%;"></div>

                        <div class="relative z-10 flex flex-col items-center gap-3" id="step-booked"><div class="status-dot w-3 h-3 rounded-full bg-white/20 transition-all duration-500"></div><span class="text-[10px] uppercase tracking-widest text-white/30 font-bold bg-obsidian px-2 transition-colors">{t('client.booked')}</span></div>
                        <div class="relative z-10 flex flex-col items-center gap-3" id="step-shooting"><div class="status-dot w-3 h-3 rounded-full bg-white/20 transition-all duration-500"></div><span class="text-[10px] uppercase tracking-widest text-white/30 font-bold bg-obsidian px-2 transition-colors">{t('client.shooting')}</span></div>
                        <div class="relative z-10 flex flex-col items-center gap-3" id="step-editing"><div class="status-dot w-3 h-3 rounded-full bg-white/20 transition-all duration-500"></div><span class="text-[10px] uppercase tracking-widest text-white/30 font-bold bg-obsidian px-2 transition-colors">{t('client.editing')}</span></div>
                        <div class="relative z-10 flex flex-col items-center gap-3" id="step-ready"><div class="status-dot w-3 h-3 rounded-full bg-white/20 transition-all duration-500"></div><span class="text-[10px] uppercase tracking-widest text-white/30 font-bold bg-obsidian px-2 transition-colors">{t('client.ready')}</span></div>
                    </div>

                    <p class="text-center text-white/40 text-xs mt-8 font-light">
                        {t('client.current_phase')}: <span id="current-stage-text" class="text-gold font-bold"></span>.
                        {t('client.est_delivery')}: <span id="delivery-est-text" class="text-white"></span>
                    </p>
                </div>

                <div id="no-project-msg" class="hidden bg-white/[0.02] border border-white/5 border-dashed p-10 rounded-xl mb-8 text-center">
                    <p class="text-white/30 text-sm mb-4">{t('client.no_project')}</p>
                    <button data-cal-link="roman-wantulok-biq4wy/photoshoot-consultation" class="book-cal-btn inline-block border border-white/10 px-6 py-2 text-[10px] uppercase tracking-widest text-gold hover:border-gold transition-colors cursor-pointer">
                        {t('client.book_now')}
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 relative overflow-hidden rounded-xl border border-white/5 h-64 md:h-auto grayscale opacity-60 cursor-not-allowed">
                        <div class="absolute inset-0 bg-black/60 z-10"></div>
                        <img src="/assets/images/americka-sila/hero.webp" class="absolute inset-0 w-full h-full object-cover" alt="Collection Preview" />
                        <div class="absolute inset-0 z-20 p-8 flex flex-col justify-end items-start">
                            <span class="bg-white/10 text-white/50 text-[10px] font-bold uppercase tracking-widest px-3 py-1 mb-3">Locked</span>
                            <h3 class="text-3xl text-white/50 font-serif italic mb-2">{t('client.main_collection')}</h3>
                            <p class="text-white/30 text-sm mb-6 max-w-md">{t('client.gallery_desc')}</p>
                            <button disabled class="border border-white/10 bg-transparent px-6 py-3 text-white/30 text-xs uppercase tracking-[0.2em] cursor-not-allowed">Waiting for project</button>
                        </div>
                    </div>

                    <div class="flex flex-col gap-6">
                        <div class="bg-white/[0.03] border border-white/10 p-6 rounded-xl hover:border-gold/30 transition-colors">
                            <h3 class="text-lg text-white font-serif mb-1">{t('client.next_session')}</h3>
                            <p class="text-white/40 text-xs mb-4">{t('client.check_availability')}</p>
                            <button class="book-cal-btn w-full border border-white/20 py-3 text-[10px] uppercase tracking-widest text-white hover:bg-gold hover:text-black hover:border-gold transition-colors cursor-pointer" data-cal-link="roman-wantulok-biq4wy/photoshoot-consultation">
                                {t('client.book_now')}
                            </button>
                        </div>
                        <div class="bg-white/[0.03] border border-white/10 p-6 rounded-xl hover:border-gold/30 transition-colors flex-1 flex flex-col justify-center">
                            <h3 class="text-lg text-white font-serif mb-1">{t('client.support')}</h3>
                            <p class="text-white/40 text-xs mb-4">{t('client.direct_line')}</p>
                            <a href="https://wa.me/420732214018" target="_blank" class="flex items-center gap-3 text-gold text-xs uppercase tracking-widest group cursor-pointer">
                                <span class="group-hover:underline">{t('client.chat_whatsapp')}</span> <span class="group-hover:translate-x-1 transition-transform">→</span>
                            </a>
                        </div>
                    </div>

                    <div class="md:col-span-3 bg-white/[0.02] border border-white/10 p-8 rounded-xl mt-4">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl text-white font-serif">{t('client.documents')}</h3>
                            <span class="text-[10px] bg-white/10 text-white/50 px-2 py-1 rounded">{t('client.secure_storage')}</span>
                        </div>
                        <div id="files-list" class="space-y-2">
                            <div class="text-center py-8 text-platinum/50 text-xs animate-pulse">{t('client.loading_docs')}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </main>

    <div id="feedback-modal" class="hidden fixed inset-0 z-[9999] h-screen w-screen flex items-center justify-center px-4">
        <div id="feedback-overlay" class="absolute inset-0 bg-black/30 backdrop-blur-md transition-opacity duration-300"></div>
        <div class="relative bg-obsidian border border-white/10 w-full max-w-lg p-10 shadow-2xl rounded-xl text-center animate-pop-in mx-auto overflow-hidden">
            <button id="close-feedback-btn" class="absolute top-4 right-4 text-white/30 hover:text-white transition-colors p-2 cursor-pointer z-50">✕</button>
            <div id="feedback-form" class="transition-all duration-500">
                <h2 class="text-3xl font-serif text-white italic mb-2">{t('client.rate')}</h2>
                <p class="text-white/40 text-xs mb-8">Your feedback helps us improve.</p>
                <div class="flex justify-center gap-4 mb-8" id="star-rating">
                    {[1,2,3,4,5].map(i => <button type="button" data-star={i} class="text-white/20 hover:text-gold text-4xl transition-colors transform hover:scale-110 cursor-pointer">★</button>)}
                </div>
                <textarea id="feedback-comment" placeholder="Tell me more..." class="w-full bg-white/5 border border-white/10 p-4 text-white text-sm focus:border-gold outline-none mb-6 h-32 resize-none placeholder:text-white/20 rounded-md"></textarea>
                <button id="submit-feedback-btn" class="w-full bg-white text-black py-4 text-xs font-bold uppercase tracking-[0.2em] hover:bg-gold transition-colors rounded cursor-pointer">Submit Feedback</button>
            </div>
            <div id="feedback-success" class="hidden flex-col items-center justify-center py-8 animate-fade-in-up">
                <h2 class="text-3xl font-serif text-white italic mb-2">Thank You</h2>
                <p class="text-white/50 text-sm">Your feedback has been received.</p>
            </div>
        </div>
    </div>

</Layout>

<script is:inline>
  (function (C, A, L) { let p = function (a, ar) { a.q.push(ar); }; let d = C.document; C.Cal = C.Cal || function () { let cal = C.Cal; let ar = arguments; if (!cal.loaded) { cal.ns = {}; cal.q = cal.q || []; d.head.appendChild(d.createElement("script")).src = A; cal.loaded = true; } if (ar[0] === L) { const api = function () { p(api, arguments); }; const namespace = ar[1]; api.q = api.q || []; typeof namespace === "string" ? (cal.ns[namespace] = api) && p(api, arguments) : p(cal, arguments); return; } p(cal, arguments); }; })(window, "https://app.cal.com/embed/embed.js", "init");
  try { Cal("init", {origin:"https://cal.com"}); Cal("ui", {"styles": { "branding": { "brandColor": "#C5A059" } }, "hideEventTypeDetails": false, "layout": "month_view", "theme": "dark"}); } catch(e) { console.error(e); }
</script>

<script>
    import { supabase } from "../../lib/supabaseClient";

    document.addEventListener('DOMContentLoaded', () => {
        let currentUserEmail = "";
        let currentRating = 0;

        // Elements
        const authContainer = document.getElementById('auth-container');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const verifyMessage = document.getElementById('verify-message');
        const backToLoginBtn = document.getElementById('back-to-login-btn');
        const errorMsg = document.getElementById('error-message');
        const userNameDisplay = document.getElementById('user-name-display');
        const userEmailDisplay = document.getElementById('user-email-display');
        const greetingText = document.getElementById('greeting-text');
        const authTitle = document.getElementById('auth-title');
        const filesList = document.getElementById('files-list');
        
        // Status Card Elements
        const projectStatusCard = document.getElementById('project-status-card');
        const noProjectMsg = document.getElementById('no-project-msg');
        const statusProgressBar = document.getElementById('status-progress-bar');
        const currentStageText = document.getElementById('current-stage-text');
        const deliveryEstText = document.getElementById('delivery-est-text');
        const projectNameDisplay = document.getElementById('project-name-display');

        // Helpers
        const switchForm = (hideForm, showForm, title) => {
            if (!hideForm || !showForm) return;
            hideForm.classList.add('hidden');
            showForm.classList.remove('hidden');
            if(authTitle) authTitle.innerText = title;
            if(errorMsg) errorMsg.classList.add('hidden');
        };

        const setLoading = (btn, isLoading) => {
            if(!btn) return;
            const textSpan = btn.querySelector('.btn-text');
            const spinner = btn.querySelector('.loading-spinner');
            if(isLoading) {
                if(textSpan) textSpan.classList.add('hidden');
                if(spinner) spinner.classList.remove('hidden');
                btn.disabled = true;
            } else {
                if(textSpan) textSpan.classList.remove('hidden');
                if(spinner) spinner.classList.add('hidden');
                btn.disabled = false;
            }
        };

        // --- AUTH ---
        loginForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = loginForm.querySelector('button');
            setLoading(btn, true);
            const email = (document.getElementById('loginEmail') as HTMLInputElement).value;
            const password = (document.getElementById('loginPassword') as HTMLInputElement).value;
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) { 
                if(errorMsg) { errorMsg.innerText = "Error: " + error.message; errorMsg.classList.remove('hidden'); }
                setLoading(btn, false);
            } else { showDashboard(data.user); }
        });

        // TADY JE TA OPRAVENÁ REGISTRACE (Spam protection + Česká hláška)
        registerForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = registerForm.querySelector('button');
            setLoading(btn, true); // Zablokuje tlačítko
            if(errorMsg) errorMsg.classList.add('hidden'); // Skryje staré chyby

            const name = (document.getElementById('regName') as HTMLInputElement).value;
            const email = (document.getElementById('regEmail') as HTMLInputElement).value;
            const password = (document.getElementById('regPassword') as HTMLInputElement).value;
            
            const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { full_name: name } } });
            
            if (error) {
                // TADY CHYTÁME "Already registered"
                let msg = error.message;
                if (error.message.includes("already registered") || error.status === 422 || error.status === 400) {
                     msg = "Tento e-mail už u nás evidujeme. Pokud si myslíte, že nejste registrovaní, zkontrolujte si prosím e-mail (i složku Spam) nebo zkuste obnovit heslo.";
                }

                if(errorMsg) { 
                    errorMsg.innerText = msg; 
                    errorMsg.classList.remove('hidden'); 
                }
                setLoading(btn, false); // Odblokujeme, aby to mohli opravit
            } else {
                if (data.user && !data.session) {
                    registerForm.classList.add('hidden');
                    verifyMessage?.classList.remove('hidden');
                    if(authTitle) authTitle.innerText = "Verify Email";
                } else if(data.session) {
                    showDashboard(data.session.user);
                }
                setLoading(btn, false);
            }
        });

        document.getElementById('show-register-btn')?.addEventListener('click', (e) => { e.preventDefault(); switchForm(loginForm, registerForm, "Create Account"); });
        document.getElementById('show-login-btn')?.addEventListener('click', (e) => { e.preventDefault(); switchForm(registerForm, loginForm, "Client Login"); });
        backToLoginBtn?.addEventListener('click', (e) => { e.preventDefault(); verifyMessage?.classList.add('hidden'); loginForm?.classList.remove('hidden'); if(authTitle) authTitle.innerText = "Client Login"; });
        document.getElementById('logout-btn')?.addEventListener('click', async () => { await supabase.auth.signOut(); location.reload(); });

        // --- DASHBOARD ---
        function showDashboard(user) {
            if (authContainer && dashboardSection) {
                authContainer.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                currentUserEmail = user.email; 
                if(userNameDisplay) userNameDisplay.innerText = user.user_metadata.full_name || "Client";
                if(userEmailDisplay) userEmailDisplay.innerText = currentUserEmail;
                const h = new Date().getHours();
                if(greetingText) {
                    if(h >= 5 && h < 12) greetingText.innerText = greetingText.dataset.morning || "Good Morning";
                    else if(h >= 12 && h < 18) greetingText.innerText = greetingText.dataset.afternoon || "Good Afternoon";
                    else greetingText.innerText = greetingText.dataset.evening || "Good Evening";
                }
                fetchProjectStatus(currentUserEmail);
                fetchUserFiles(currentUserEmail);
            }
        }

        supabase.auth.getSession().then(({ data: { session } }) => { if (session) showDashboard(session.user); });

        // --- FETCH DATA ---
        async function fetchProjectStatus(email) {
            const { data, error } = await supabase.from('client_projects').select('*').eq('client_email', email).single();
            const steps = ['booked', 'shooting', 'editing', 'ready'];

            if (error || !data) {
                projectStatusCard?.classList.add('hidden');
                noProjectMsg?.classList.remove('hidden');
                return;
            }

            projectStatusCard?.classList.remove('hidden');
            noProjectMsg?.classList.add('hidden');
            
            if(projectNameDisplay) projectNameDisplay.innerText = data.project_name || "Project";
            if(deliveryEstText) deliveryEstText.innerText = data.delivery_estimate || "TBD";
            if(currentStageText) currentStageText.innerText = (data.status || '').toUpperCase();
            
            const idx = steps.indexOf((data.status || '').toLowerCase());
            let width = 0;
            if (data.progress !== null && data.progress !== undefined && data.progress > 0) { width = data.progress; } 
            else { width = Math.max(0, Math.min(100, idx * 33)); }
            
            if(statusProgressBar) statusProgressBar.style.width = `${width}%`;
            
            steps.forEach((step, index) => { 
                const el = document.getElementById(`step-${step}`); 
                if(!el) return; 
                const dot = el.querySelector('.status-dot'); 
                const label = el.querySelector('span'); 
                if (index <= idx) { 
                    dot?.classList.remove('bg-white/20'); dot?.classList.add('bg-gold', 'shadow-[0_0_10px_#C5A059]'); 
                    label?.classList.remove('text-white/30'); label?.classList.add('text-gold'); 
                    if(index === idx) dot?.classList.add('animate-pulse'); else dot?.classList.remove('animate-pulse'); 
                } else { 
                    dot?.classList.add('bg-white/20'); dot?.classList.remove('bg-gold', 'shadow-[0_0_10px_#C5A059]', 'animate-pulse'); 
                    label?.classList.add('text-white/30'); label?.classList.remove('text-gold'); 
                } 
            });
        }

        async function fetchUserFiles(email) {
            const { data } = await supabase.from('user_files').select('*').eq('assigned_email', email);
            if(filesList) { 
                filesList.innerHTML = ""; 
                if(data && data.length) { 
                    data.forEach((file) => { 
                        filesList.innerHTML += `<div class="flex items-center justify-between bg-white/5 p-4 rounded hover:bg-white/10 transition-colors border border-white/5 group"><div class="flex items-center gap-4"><div class="w-8 h-8 bg-gold/20 text-gold flex items-center justify-center rounded"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg></div><div><p class="text-white text-sm font-medium group-hover:text-gold transition-colors">${file.title}</p></div></div><a href="${file.file_url}" target="_blank" class="text-gold text-[10px] uppercase tracking-wider hover:text-white transition-colors border-b border-gold/30 pb-1 cursor-pointer">Download</a></div>`; 
                    }); 
                } else { 
                    filesList.innerHTML = '<div class="text-white/50 text-xs p-4">No documents yet.</div>';
                } 
            }
        }

        // --- BOOKING BUTTONS (Multiple) ---
        const bookBtns = document.querySelectorAll('.book-cal-btn');
        bookBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // @ts-ignore
                if (typeof Cal !== 'undefined') { 
                    // @ts-ignore
                    Cal("modal", { calLink: "roman-wantulok-biq4wy/photoshoot-consultation", config: { theme: 'dark' } }); 
                } else {
                    window.open("https://cal.com/roman-wantulok-biq4wy/photoshoot-consultation", "_blank");
                }
            });
        });

        // --- FEEDBACK ---
        const feedbackModal = document.getElementById('feedback-modal');
        const starButtons = document.querySelectorAll('#star-rating button');
        const submitFeedbackBtn = document.getElementById('submit-feedback-btn');
        const feedbackComment = document.getElementById('feedback-comment');
        
        starButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                // @ts-ignore
                const rating = parseInt(btn.getAttribute('data-star'));
                currentRating = rating;
                starButtons.forEach(s => {
                    // @ts-ignore
                    const sVal = parseInt(s.getAttribute('data-star'));
                    if (sVal <= rating) { s.classList.remove('text-white/20'); s.classList.add('text-gold'); }
                    else { s.classList.add('text-white/20'); s.classList.remove('text-gold'); }
                });
            });
        });

        submitFeedbackBtn?.addEventListener('click', async () => {
            if (currentRating === 0) { alert("Please select a star rating first."); return; }
            // @ts-ignore
            const comment = feedbackComment?.value || "";
            const { error } = await supabase.from('client_feedback').insert({ client_email: currentUserEmail, rating: currentRating, comment: comment });
            if (!error) { 
                feedbackModal?.classList.add('hidden'); 
                alert("Thank you for your feedback!"); 
            }
        });

        document.getElementById('open-feedback-btn')?.addEventListener('click', () => feedbackModal?.classList.remove('hidden'));
        document.getElementById('close-feedback-btn')?.addEventListener('click', () => feedbackModal?.classList.add('hidden'));
    });
</script>

<style>
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    
    @keyframes popIn { 0% { opacity: 0; transform: scale(0.95) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
    .animate-pop-in { animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

    :global(#custom-cursor), :global(#cursor-follower) { z-index: 20000 !important; pointer-events: none; }
    #feedback-modal, #feedback-modal button, #feedback-modal textarea, #feedback-modal a, #internal-gallery-view, #lightbox { cursor: none !important; }
</style>